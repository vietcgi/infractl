apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring
  namespace: monitoring
  labels:
    app.kubernetes.io/part-of: monitoring
    app.kubernetes.io/environment: prod
    topology.kubernetes.io/region: us-west-2
    topology.kubernetes.io/zone: us-west-2a
    cluster: dc11a
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

  # Ingress rules
  ingress:
  # Allow Prometheus scraping from kube-prometheus-stack
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: monitoring
      podSelector:
        matchLabels:
          app.kubernetes.io/name: prometheus
    ports:
    - protocol: TCP
      port: 9090  # Prometheus

  # Allow node-exporter access from Prometheus
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: monitoring
      podSelector:
        matchLabels:
          app.kubernetes.io/name: prometheus
    ports:
    - protocol: TCP
      port: 9100  # node-exporter

  # Allow kubelet metrics access
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: monitoring
      podSelector:
        matchLabels:
          app.kubernetes.io/name: prometheus
    ports:
    - protocol: TCP
      port: 10250  # kubelet metrics

  # Allow Grafana access from ingress-nginx
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: ingress-nginx
      podSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    ports:
    - protocol: TCP
      port: 3000  # Grafana

  # Allow Alertmanager access from Prometheus
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: monitoring
      podSelector:
        matchLabels:
          app.kubernetes.io/name: prometheus
    ports:
    - protocol: TCP
      port: 9093  # Alertmanager web
    - protocol: TCP
      port: 9094  # Alertmanager cluster

  # Egress rules
  egress:
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

  # Allow Prometheus to scrape metrics
  - to:
    - namespaceSelector: {}
      podSelector:
        matchExpressions:
        - key: k8s-app
          operator: Exists
    ports:
    - protocol: TCP
      portRange: 1-65535

  # Allow access to kube-apiserver
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: default
      podSelector:
        matchLabels:
          component: kube-apiserver
    ports:
    - protocol: TCP
      port: 443

  # Allow access to etcd
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          component: etcd
    ports:
    - protocol: TCP
      port: 2379
    - protocol: TCP
      port: 2380
