apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: rancher
  namespace: cattle-system
  labels:
    app.kubernetes.io/name: rancher
    app.kubernetes.io/part-of: management
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

  # Allow HTTP/HTTPS access to Rancher server
  ingress:
  - from:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app: rancher
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 6443  # k8s API

  # Allow metrics access
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: monitoring
    ports:
    - protocol: TCP
      port: 9796  # metrics

  # Allow cluster agent communication
  - from:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app: cattle-cluster-agent
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app: cattle-node-agent
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80

  # Allow all egress traffic
  egress: [{}]

---
# Label the cattle-system namespace
apiVersion: v1
kind: Namespace
metadata:
  name: cattle-system
  labels:
    kubernetes.io/metadata.name: cattle-system
