apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: longhorn
  namespace: longhorn-system
  labels:
    app.kubernetes.io/name: longhorn
    app.kubernetes.io/part-of: storage
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

  # Allow Longhorn manager API access
  ingress:
  - from:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app: longhorn-manager
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app: longhorn-ui
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app.kubernetes.io/name: longhorn
    ports:
    - protocol: TCP
      port: 9500  # manager API
    - protocol: TCP
      port: 8000  # UI

  # Allow CSI operations
  - from:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app: csi-attacher
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app: csi-provisioner
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app: csi-resizer
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app: csi-snapshotter
    ports:
    - protocol: TCP
      port: 9500  # CSI operations

  # Allow node communication
  - from:
    - podSelector:
        matchLabels:
          app: longhorn-manager
    - podSelector:
        matchLabels:
          app: longhorn-csi-plugin
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: longhorn
    ports:
    - protocol: TCP
      port: 1-65535  # Allow all ports between nodes

  # Allow all egress traffic
  egress: [{}]

---
# Label the longhorn-system namespace
apiVersion: v1
kind: Namespace
metadata:
  name: longhorn-system
  labels:
    kubernetes.io/metadata.name: longhorn-system
