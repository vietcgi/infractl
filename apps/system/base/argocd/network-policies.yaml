apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: argocd
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd
    app.kubernetes.io/part-of: gitops
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

  # Allow ArgoCD server API access
  ingress:
  - from:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app.kubernetes.io/name: argocd-application-controller
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app.kubernetes.io/name: argocd-repo-server
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app.kubernetes.io/name: argocd-server
    ports:
    - protocol: TCP
      port: 8080  # HTTP metrics
    - protocol: TCP
      port: 8083  # gRPC metrics
    - protocol: TCP
      port: 8084  # gRPC
    - protocol: TCP
      port: 8085  # gRPC web
    - protocol: TCP
      port: 8086  # metrics
    - protocol: TCP
      port: 8087  # metrics
    - protocol: TCP
      port: 8088  # metrics
    - protocol: TCP
      port: 8089  # metrics
    - protocol: TCP
      port: 8090  # metrics
    - protocol: TCP
      port: 8091  # metrics

  # Allow web UI access
  - from:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app.kubernetes.io/name: argocd-server
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443

  # Allow Redis access
  - from:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app.kubernetes.io/name: argocd-application-controller
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app.kubernetes.io/name: argocd-server
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app.kubernetes.io/name: argocd-repo-server
    ports:
    - protocol: TCP
      port: 6379

  # Allow all egress traffic
  egress: [{}]

---
# Label the argocd namespace
apiVersion: v1
kind: Namespace
metadata:
  name: argocd
  labels:
    kubernetes.io/metadata.name: argocd
